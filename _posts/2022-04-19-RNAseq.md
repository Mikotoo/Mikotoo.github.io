---
title: RNA-seq数据分析
author: 
date: 2022-04-19
category: Jekyll
layout: post
---
> **RNA-seq** hisat2 —— stringtie —— DESeq2 pipeline

#### 1、需求
##### 1.1 软件
linux安装：<br>
hisat2      `conda install hisat2`<br>
stringtie   `conda install stringtie`<br>
samtools    `conda install samtools=1.15.1`<br>
gffread     `conda install gffread`

R包：<br>
DESeq2  `BiocManager::install('DESeq2')`
##### 1.2 数据
(1) fastq测序数据<br>
![pic1][1]
> 如图中例子，有9个样本，每个样本3个重复，双端测序

数据质控略

(2) 基因组及其gff注释文件，下载自[Phytozome][2]<br>
gff转为gtf备用：    `gffread Wm82.gff3 -T -o Wm82.gtf`

#### 2、比对
##### 2.1 构建索引
`hisat2-build -p 8 path/to/genome.fa Wm82`

##### 2.2 准备config文件
```
ls path/to/fastq/*R1* > 1
ls path/to/fastq/*R2* > 2
ls path/to/fastq/*R2* | cut -d '/' -f 6 | cut -d '_' -f 1-3 > 0
paste 0 1 2 > align.config
```

##### 2.3 比对
```
#!/bin/bash
hisat_index=/pub4/zhangchao/Methylome_Soybean/Reference/index/Wm82
cat align.config | while read id;
do
arr=($id)
fq2=${arr[2]}
fq1=${arr[1]}
sample=${arr[0]}
hisat2 -p 20 -x ${hisat_index} -1 $fq1 -2 $fq2 -S ${sample}.sam 2>${sample}_hisat.log
grep "NH:i:1" ${sample}.sam > ${sample}_unique.sam      #仅保留唯一比对
samtools view -H ${sample}.sam > ${sample}_head.sam
cat ${sample}_unique.sam >> ${sample}_head.sam
samtools sort -@ 20 -o ${sample}.bam ${sample}_head.sam
samtools index ${sample}.bam
rm ${sample}_unique.sam
rm ${sample}_head.sam
stringtie -p 20 -G path/to/Wm82.gtf -e -B -o ${sample}.gtf -A ${sample}.tsv ${sample}.bam
done
```

##### 2.4 从tsv文件提取fpkm信息
```
ls *tsv|cut -d '.' -f 1|while read id;
do 
nohup cat ${id}.tsv | awk -F "\t" '{print $1"\t"$8}' > fpkm/${id}.fpkm &
done
```

##### 2.5 从gtf文件提取count信息
```
ls path/to/gtf/*gtf > gtf
ls path/to/fastq/*R2* | cut -d '/' -f 7 | cut -d '_' -f 1-3 > name
paste name gtf > prepDE.list
python path/to/prepDE.py -i path/to/prepDE.list -g prepDE_counts.csv -t prepDE_transcript.csv
sed 's/,/\t/' prepDE_counts.csv > all_count.txt
```


[1]: https://github.com/Mikotoo/Mikotoo.github.io/raw/main/downloads/image/blog4_rnaseq/fastq.png
[2]: https://mikotoo.github.io/jekyll/2022-04-07-genome.html